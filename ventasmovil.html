<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Control de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f3f4f6;
            overscroll-behavior: none;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .touch-manipulation { touch-action: manipulation; }
        
        /* Bottom sheet animation */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        /* Card press effect */
        .press-effect:active { transform: scale(0.98); }
        
        /* Floating button */
        .fab {
            position: fixed;
            bottom: calc(1.5rem + env(safe-area-inset-bottom));
            right: 1.5rem;
            z-index: 40;
        }
        
        /* Mobile optimizations */
        input, button, select, textarea {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 antialiased">

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 z-50 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex flex-col justify-center p-6 safe-top safe-bottom">
        <div class="w-full max-w-sm mx-auto">
            <div class="text-center mb-10">
                <div class="w-24 h-24 bg-white/20 rounded-3xl mx-auto flex items-center justify-center mb-6 backdrop-blur-sm">
                    <i class="fas fa-store text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Mi Negocio</h1>
                <p class="text-white/80">Control de Ventas Móvil</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-1">
                    <input type="text" id="businessName" required placeholder="Nombre del negocio" 
                        class="w-full bg-transparent text-white placeholder-white/60 px-4 py-4 outline-none border-b border-white/20 last:border-0">
                </div>
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-1">
                    <input type="text" id="userName" required placeholder="Tu nombre" 
                        class="w-full bg-transparent text-white placeholder-white/60 px-4 py-4 outline-none">
                </div>
                <button type="submit" class="w-full bg-white text-indigo-600 font-bold py-4 rounded-2xl mt-6 shadow-lg active:scale-95 transition-transform">
                    Comenzar
                </button>
            </form>
            
            <div class="mt-8 text-center text-white/60 text-sm">
                <p>Los datos se guardan en tu dispositivo</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen pb-24">
        
        <!-- Header -->
        <header class="fixed top-0 left-0 right-0 bg-indigo-600 text-white z-30 safe-top shadow-lg">
            <div class="flex items-center justify-between px-4 py-4">
                <div>
                    <h1 class="text-lg font-bold" id="headerTitle">Dashboard</h1>
                    <p class="text-xs text-indigo-200" id="headerSubtitle">Resumen de hoy</p>
                </div>
                <button onclick="logout()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center active:bg-white/30 transition-colors">
                    <i class="fas fa-sign-out-alt text-sm"></i>
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="pt-20 px-4 space-y-4">

            <!-- Dashboard -->
            <section id="dashboard" class="section-content space-y-4">
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white rounded-2xl p-4 shadow-sm press-effect">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600 text-sm"></i>
                            </div>
                            <span class="text-xs text-gray-500">Ventas Hoy</span>
                        </div>
                        <p class="text-xl font-bold text-gray-800" id="todaySales">$0</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-4 shadow-sm press-effect">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-receipt text-blue-600 text-sm"></i>
                            </div>
                            <span class="text-xs text-gray-500">Ventas</span>
                        </div>
                        <p class="text-xl font-bold text-gray-800" id="todayTransactions">0</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-3">Acciones Rápidas</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="showSection('sales')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-indigo-50 text-indigo-600 active:bg-indigo-100 transition-colors">
                            <i class="fas fa-plus-circle text-2xl"></i>
                            <span class="text-xs font-medium">Nueva Venta</span>
                        </button>
                        <button onclick="showSection('products')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-purple-50 text-purple-600 active:bg-purple-100 transition-colors">
                            <i class="fas fa-box text-2xl"></i>
                            <span class="text-xs font-medium">Productos</span>
                        </button>
                        <button onclick="showSection('history')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-pink-50 text-pink-600 active:bg-pink-100 transition-colors">
                            <i class="fas fa-history text-2xl"></i>
                            <span class="text-xs font-medium">Historial</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Sales -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-gray-800">Ventas Recientes</h3>
                        <button onclick="showSection('history')" class="text-indigo-600 text-sm font-medium">Ver todo</button>
                    </div>
                    <div id="recentSalesList" class="space-y-3">
                        <p class="text-gray-400 text-center py-4 text-sm">No hay ventas recientes</p>
                    </div>
                </div>
            </section>

            <!-- New Sale -->
            <section id="sales" class="section-content hidden space-y-4">
                <!-- Search -->
                <div class="relative">
                    <input type="text" id="productSearch" placeholder="Buscar producto..." 
                        class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-indigo-500"
                        oninput="filterProducts()">
                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                </div>

                <!-- Products Grid -->
                <div class="grid grid-cols-2 gap-3" id="productsGrid"></div>

                <!-- Empty State -->
                <div id="emptyProducts" class="hidden text-center py-12">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-box-open text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-500 text-sm">No hay productos</p>
                    <button onclick="showSection('products')" class="mt-2 text-indigo-600 font-medium text-sm">Agregar producto</button>
                </div>
            </section>

            <!-- Cart Sheet (Bottom) -->
            <div id="cartSheet" class="fixed inset-0 z-40 hidden">
                <div class="absolute inset-0 bg-black/50" onclick="closeCart()"></div>
                <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[80vh] overflow-hidden flex flex-col safe-bottom">
                    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                        <h3 class="font-bold text-lg">Ticket de Venta</h3>
                        <button onclick="closeCart()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-times text-gray-600"></i>
                        </button>
                    </div>
                    
                    <div id="cartItemsMobile" class="flex-1 overflow-y-auto p-4 space-y-3 max-h-96">
                        <p class="text-gray-400 text-center py-8">Carrito vacío</p>
                    </div>

                    <div class="p-4 border-t border-gray-100 bg-gray-50 space-y-3">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span id="cartSubtotal">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>IVA (16%)</span>
                            <span id="cartTax">$0.00</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-gray-800 pt-2 border-t border-gray-200">
                            <span>Total</span>
                            <span id="cartTotal">$0.00</span>
                        </div>
                        <button onclick="processPayment()" id="btnCheckout" disabled 
                            class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed active:bg-indigo-700 transition-colors">
                            Proceder al Pago
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payment Sheet -->
            <div id="paymentSheet" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-black/50" onclick="closePayment()"></div>
                <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 safe-bottom">
                    <h3 class="font-bold text-lg mb-4">Método de Pago</h3>
                    <div class="space-y-3 mb-6">
                        <button onclick="selectPaymentMethod('cash')" class="payment-option w-full flex items-center gap-4 p-4 rounded-2xl border-2 border-gray-200 active:border-indigo-500 active:bg-indigo-50 transition-all" data-method="cash">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-semibold">Efectivo</div>
                                <div class="text-sm text-gray-500">Pago en efectivo</div>
                            </div>
                        </button>
                        <button onclick="selectPaymentMethod('card')" class="payment-option w-full flex items-center gap-4 p-4 rounded-2xl border-2 border-gray-200 active:border-indigo-500 active:bg-indigo-50 transition-all" data-method="card">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-credit-card text-blue-600 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-semibold">Tarjeta</div>
                                <div class="text-sm text-gray-500">Débito o crédito</div>
                            </div>
                        </button>
                        <button onclick="selectPaymentMethod('transfer')" class="payment-option w-full flex items-center gap-4 p-4 rounded-2xl border-2 border-gray-200 active:border-indigo-500 active:bg-indigo-50 transition-all" data-method="transfer">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-purple-600 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-semibold">Transferencia</div>
                                <div class="text-sm text-gray-500">SPEI o wallets</div>
                            </div>
                        </button>
                    </div>
                    <button onclick="confirmSale()" id="btnConfirmSale" disabled 
                        class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed active:bg-indigo-700 transition-colors">
                        Confirmar Venta
                    </button>
                </div>
            </div>

            <!-- Products Management -->
            <section id="products" class="section-content hidden space-y-4">
                <button onclick="openAddProduct()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg active:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </button>

                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <input type="text" id="productListSearch" placeholder="Buscar en inventario..." 
                            class="w-full px-4 py-2 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
                            oninput="renderProductsList()">
                    </div>
                    <div id="productsList" class="divide-y divide-gray-100 max-h-96 overflow-y-auto hide-scrollbar">
                        <!-- Products injected here -->
                    </div>
                </div>
            </section>

            <!-- Add Product Modal -->
            <div id="addProductModal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
                <div class="absolute inset-0 bg-black/50" onclick="closeAddProduct()"></div>
                <div class="relative bg-white w-full sm:w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 safe-bottom max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Nuevo Producto</h3>
                        <button onclick="closeAddProduct()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-times text-gray-600"></i>
                        </button>
                    </div>
                    <form id="addProductForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del producto</label>
                            <input type="text" id="newProdName" required class="w-full px-4 py-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Precio</label>
                                <input type="number" id="newProdPrice" step="0.01" required class="w-full px-4 py-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
                                <input type="number" id="newProdStock" required class="w-full px-4 py-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl active:bg-indigo-700 transition-colors mt-4">
                            Guardar Producto
                        </button>
                    </form>
                </div>
            </div>

            <!-- History -->
            <section id="history" class="section-content hidden space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                    <div class="flex gap-2">
                        <input type="date" id="historyDateFilter" onchange="renderHistory()" 
                            class="flex-1 px-4 py-2 bg-gray-100 rounded-xl outline-none text-sm">
                        <select id="historyPaymentFilter" onchange="renderHistory()" 
                            class="px-4 py-2 bg-gray-100 rounded-xl outline-none text-sm">
                            <option value="">Todos</option>
                            <option value="cash">Efectivo</option>
                            <option value="card">Tarjeta</option>
                            <option value="transfer">Transferencia</option>
                        </select>
                    </div>
                </div>

                <div id="historyList" class="space-y-3">
                    <!-- History items injected here -->
                </div>
            </section>

            <!-- Sale Detail Modal -->
            <div id="saleDetailModal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
                <div class="absolute inset-0 bg-black/50" onclick="closeSaleDetail()"></div>
                <div class="relative bg-white w-full sm:w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 safe-bottom max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Detalle de Venta</h3>
                        <button onclick="closeSaleDetail()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-times text-gray-600"></i>
                        </button>
                    </div>
                    <div id="saleDetailContent"></div>
                </div>
            </div>

        </main>

        <!-- Floating Cart Button -->
        <button id="fabCart" onclick="openCart()" class="fab w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-transform hidden">
            <div class="relative">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cartBadge" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">0</span>
            </div>
        </button>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-30 safe-bottom shadow-lg">
            <div class="flex justify-around items-center py-2">
                <button onclick="showSection('dashboard')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-indigo-600" data-section="dashboard">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-[10px] font-medium">Inicio</span>
                </button>
                <button onclick="showSection('sales')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-gray-400" data-section="sales">
                    <i class="fas fa-plus-circle text-xl"></i>
                    <span class="text-[10px] font-medium">Venta</span>
                </button>
                <button onclick="showSection('products')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-gray-400" data-section="products">
                    <i class="fas fa-box text-xl"></i>
                    <span class="text-[10px] font-medium">Productos</span>
                </button>
                <button onclick="showSection('history')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-gray-400" data-section="history">
                    <i class="fas fa-history text-xl"></i>
                    <span class="text-[10px] font-medium">Historial</span>
                </button>
            </div>
        </nav>

        <!-- Toast -->
        <div id="toast" class="fixed top-24 left-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-xl shadow-2xl transform -translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
            <i class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage" class="text-sm font-medium">Operación exitosa</span>
        </div>
    </div>

    <script>
        // State
        let state = {
            user: null,
            products: [],
            sales: [],
            cart: [],
            currentPayment: null
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            checkSession();
        });

        // Data Management
        function saveData() {
            localStorage.setItem('businessData', JSON.stringify({
                products: state.products,
                sales: state.sales,
                businessName: state.user?.businessName || ''
            }));
            if (state.user) {
                localStorage.setItem('userSession', JSON.stringify({
                    userName: state.user.userName,
                    businessName: state.user.businessName
                }));
            }
        }

        function loadData() {
            const data = localStorage.getItem('businessData');
            if (data) {
                const parsed = JSON.parse(data);
                state.products = parsed.products || [];
                state.sales = parsed.sales || [];
            }
        }

        function checkSession() {
            const session = localStorage.getItem('userSession');
            if (session) {
                const parsed = JSON.parse(session);
                state.user = parsed;
                showMainApp();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }

        // Auth
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            state.user = {
                businessName: document.getElementById('businessName').value,
                userName: document.getElementById('userName').value
            };
            saveData();
            showMainApp();
            showToast('¡Bienvenido!');
        });

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateDashboard();
            renderProducts();
        }

        function logout() {
            if (confirm('¿Cerrar sesión?')) {
                localStorage.removeItem('userSession');
                state.user = null;
                state.cart = [];
                location.reload();
            }
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(section).classList.remove('hidden');
            
            // Update nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.section === section;
                btn.classList.toggle('text-indigo-600', isActive);
                btn.classList.toggle('text-gray-400', !isActive);
            });

            // Update header
            const titles = {
                dashboard: ['Dashboard', 'Resumen de hoy'],
                sales: ['Nueva Venta', 'Selecciona productos'],
                products: ['Productos', 'Gestiona inventario'],
                history: ['Historial', 'Tus ventas']
            };
            document.getElementById('headerTitle').textContent = titles[section][0];
            document.getElementById('headerSubtitle').textContent = titles[section][1];

            if (section === 'products') renderProductsList();
            if (section === 'history') renderHistory();
            if (section === 'dashboard') updateDashboard();
        }

        // Dashboard
        function updateDashboard() {
            const today = new Date().toDateString();
            const todaySales = state.sales.filter(s => new Date(s.date).toDateString() === today);
            
            const total = todaySales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('todaySales').textContent = '$' + total.toLocaleString('es-MX', {maximumFractionDigits: 0});
            document.getElementById('todayTransactions').textContent = todaySales.length;

            // Recent sales
            const recent = [...state.sales].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const recentList = document.getElementById('recentSalesList');
            
            if (recent.length === 0) {
                recentList.innerHTML = '<p class="text-gray-400 text-center py-4 text-sm">No hay ventas recientes</p>';
            } else {
                recentList.innerHTML = recent.map(sale => {
                    const date = new Date(sale.date);
                    const icons = { cash: 'money-bill-wave', card: 'credit-card', transfer: 'mobile-alt' };
                    const colors = { cash: 'text-green-600 bg-green-100', card: 'text-blue-600 bg-blue-100', transfer: 'text-purple-600 bg-purple-100' };
                    return `
                        <div onclick="showSaleDetail('${sale.id}')" class="flex items-center justify-between p-3 bg-gray-50 rounded-xl active:bg-gray-100 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 ${colors[sale.paymentMethod]} rounded-lg flex items-center justify-center">
                                    <i class="fas fa-${icons[sale.paymentMethod]}"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-sm">$${sale.total.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">${sale.items.length} productos • ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                        </div>
                    `;
                }).join('');
            }
        }

        // Products
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const search = document.getElementById('productSearch').value.toLowerCase();
            const filtered = state.products.filter(p => p.name.toLowerCase().includes(search));

            if (filtered.length === 0) {
                grid.innerHTML = '';
                document.getElementById('emptyProducts').classList.remove('hidden');
                return;
            }
            
            document.getElementById('emptyProducts').classList.add('hidden');
            grid.innerHTML = filtered.map(p => `
                <div onclick="addToCart('${p.id}')" class="bg-white rounded-2xl p-4 shadow-sm press-effect ${p.stock <= 0 ? 'opacity-50' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs px-2 py-1 bg-gray-100 rounded-lg text-gray-600">${p.stock} disp.</span>
                    </div>
                    <h4 class="font-semibold text-gray-800 mb-1 line-clamp-2">${p.name}</h4>
                    <p class="text-lg font-bold text-indigo-600">$${p.price.toFixed(2)}</p>
                </div>
            `).join('');
        }

        function filterProducts() {
            renderProducts();
        }

        function renderProductsList() {
            const search = document.getElementById('productListSearch').value.toLowerCase();
            const filtered = state.products.filter(p => p.name.toLowerCase().includes(search));
            const list = document.getElementById('productsList');
            
            list.innerHTML = filtered.map(p => `
                <div class="p-4 flex items-center justify-between active:bg-gray-50 transition-colors">
                    <div>
                        <div class="font-semibold text-gray-800">${p.name}</div>
                        <div class="text-sm text-gray-500">Stock: ${p.stock} • $${p.price.toFixed(2)}</div>
                    </div>
                    <button onclick="deleteProduct('${p.id}')" class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center active:bg-red-100">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('') || '<div class="p-8 text-center text-gray-400 text-sm">No hay productos</div>';
        }

        function openAddProduct() {
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function closeAddProduct() {
            document.getElementById('addProductModal').classList.add('hidden');
        }

        document.getElementById('addProductForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const product = {
                id: Date.now().toString(),
                name: document.getElementById('newProdName').value,
                price: parseFloat(document.getElementById('newProdPrice').value),
                stock: parseInt(document.getElementById('newProdStock').value)
            };
            state.products.push(product);
            saveData();
            closeAddProduct();
            renderProducts();
            renderProductsList();
            showToast('Producto agregado');
            e.target.reset();
        });

        function deleteProduct(id) {
            if (confirm('¿Eliminar este producto?')) {
                state.products = state.products.filter(p => p.id !== id);
                saveData();
                renderProducts();
                renderProductsList();
                showToast('Producto eliminado');
            }
        }

        // Cart
        function addToCart(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                showToast('Sin stock disponible', 'error');
                return;
            }

            const existing = state.cart.find(item => item.id === productId);
            if (existing) {
                if (existing.quantity < product.stock) {
                    existing.quantity++;
                } else {
                    showToast('Stock máximo alcanzado', 'error');
                    return;
                }
            } else {
                state.cart.push({ ...product, quantity: 1 });
            }
            updateCart();
            showToast('Agregado');
        }

        function updateCart() {
            const container = document.getElementById('cartItemsMobile');
            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.16;
            const total = subtotal + tax;

            document.getElementById('cartBadge').textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('fabCart').classList.toggle('hidden', state.cart.length === 0);
            document.getElementById('btnCheckout').disabled = state.cart.length === 0;

            if (state.cart.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">Carrito vacío</p>';
            } else {
                container.innerHTML = state.cart.map(item => `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                        <div class="flex-1">
                            <div class="font-semibold text-sm">${item.name}</div>
                            <div class="text-sm text-gray-500">$${item.price.toFixed(2)} c/u</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="updateQty('${item.id}', -1)" class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center active:scale-90 transition-transform">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="w-6 text-center font-semibold">${item.quantity}</span>
                            <button onclick="updateQty('${item.id}', 1)" class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center active:scale-90 transition-transform">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                        <div class="ml-3 font-bold text-sm w-16 text-right">$${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `).join('');
            }

            document.getElementById('cartSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('cartTax').textContent = '$' + tax.toFixed(2);
            document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
        }

        function updateQty(id, delta) {
            const item = state.cart.find(i => i.id === id);
            const product = state.products.find(p => p.id === id);
            if (!item) return;
            
            const newQty = item.quantity + delta;
            if (newQty <= 0) {
                state.cart = state.cart.filter(i => i.id !== id);
            } else if (newQty <= product.stock) {
                item.quantity = newQty;
            } else {
                showToast('Stock insuficiente', 'error');
                return;
            }
            updateCart();
        }

        function openCart() {
            document.getElementById('cartSheet').classList.remove('hidden');
        }

        function closeCart() {
            document.getElementById('cartSheet').classList.add('hidden');
        }

        // Payment
        function processPayment() {
            closeCart();
            document.getElementById('paymentSheet').classList.remove('hidden');
        }

        function closePayment() {
            document.getElementById('paymentSheet').classList.add('hidden');
        }

        function selectPaymentMethod(method) {
            state.currentPayment = method;
            document.querySelectorAll('.payment-option').forEach(btn => {
                const isSelected = btn.dataset.method === method;
                btn.classList.toggle('border-indigo-500', isSelected);
                btn.classList.toggle('bg-indigo-50', isSelected);
                btn.classList.toggle('border-gray-200', !isSelected);
            });
            document.getElementById('btnConfirmSale').disabled = false;
        }

        function confirmSale() {
            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.16;
            const total = subtotal + tax;

            // Update stock
            state.cart.forEach(item => {
                const product = state.products.find(p => p.id === item.id);
                if (product) product.stock -= item.quantity;
            });

            const sale = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                items: [...state.cart],
                subtotal, tax, total,
                paymentMethod: state.currentPayment
            };

            state.sales.push(sale);
            state.cart = [];
            saveData();
            
            closePayment();
            updateCart();
            showToast('¡Venta completada!');
            
            // Reset
            state.currentPayment = null;
            document.querySelectorAll('.payment-option').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'bg-indigo-50');
                btn.classList.add('border-gray-200');
            });
            document.getElementById('btnConfirmSale').disabled = true;
            
            // Go to dashboard
            showSection('dashboard');
        }

        // History
        function renderHistory() {
            const dateFilter = document.getElementById('historyDateFilter').value;
            const paymentFilter = document.getElementById('historyPaymentFilter').value;
            
            let filtered = [...state.sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (dateFilter) {
                const filterDate = new Date(dateFilter).toDateString();
                filtered = filtered.filter(s => new Date(s.date).toDateString() === filterDate);
            }
            if (paymentFilter) {
                filtered = filtered.filter(s => s.paymentMethod === paymentFilter);
            }

            const list = document.getElementById('historyList');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-inbox text-4xl mb-2"></i><p class="text-sm">No hay ventas</p></div>';
                return;
            }

            list.innerHTML = filtered.map(sale => {
                const date = new Date(sale.date);
                const icons = { cash: 'money-bill-wave', card: 'credit-card', transfer: 'mobile-alt' };
                return `
                    <div onclick="showSaleDetail('${sale.id}')" class="bg-white rounded-2xl p-4 shadow-sm active:scale-98 transition-transform">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="text-xs text-gray-500">${date.toLocaleDateString()} • ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                <div class="font-bold text-lg mt-1">$${sale.total.toFixed(2)}</div>
                            </div>
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-${icons[sale.paymentMethod]} text-gray-600"></i>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">${sale.items.length} productos • ${sale.items.map(i => i.name).join(', ').substring(0, 30)}${sale.items.length > 1 ? '...' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function showSaleDetail(id) {
            const sale = state.sales.find(s => s.id === id);
            if (!sale) return;
            
            const date = new Date(sale.date);
            const methods = { cash: 'Efectivo', card: 'Tarjeta', transfer: 'Transferencia' };
            
            document.getElementById('saleDetailContent').innerHTML = `
                <div class="text-center mb-6">
                    <div class="text-3xl font-bold text-indigo-600 mb-1">$${sale.total.toFixed(2)}</div>
                    <div class="text-sm text-gray-500">${date.toLocaleString()}</div>
                    <div class="inline-block mt-2 px-3 py-1 bg-gray-100 rounded-full text-sm font-medium text-gray-700">${methods[sale.paymentMethod]}</div>
                </div>
                
                <div class="space-y-3 mb-6">
                    ${sale.items.map(item => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                                <div class="font-medium">${item.name}</div>
                                <div class="text-sm text-gray-500">$${item.price.toFixed(2)} × ${item.quantity}</div>
                            </div>
                            <div class="font-bold">$${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="bg-gray-50 rounded-xl p-4 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Subtotal</span>
                        <span>$${sale.subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">IVA (16%)</span>
                        <span>$${sale.tax.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-200">
                        <span>Total</span>
                        <span class="text-indigo-600">$${sale.total.toFixed(2)}</span>
                    </div>
                </div>
            `;
            document.getElementById('saleDetailModal').classList.remove('hidden');
        }

        function closeSaleDetail() {
            document.getElementById('saleDetailModal').classList.add('hidden');
        }

        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('-translate-y-20', 'opacity-0');
            }, 2500);
        }

        // Close modals on outside click
        window.onclick = function(e) {
            if (e.target.id === 'addProductModal') closeAddProduct();
            if (e.target.id === 'saleDetailModal') closeSaleDetail();
        }
    </script>
</body>
</html>